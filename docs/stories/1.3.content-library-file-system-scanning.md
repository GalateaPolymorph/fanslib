# Story 1.3: Content Library File System Scanning

## Status

Ready

## Story

**As a** content creator,
**I want** the system to automatically discover and catalog my existing content library with shoot-based organization,
**so that** I can immediately browse and work with my organized media files in FansLib.

## Acceptance Criteria

1. Content library bound to local file system via volume mount (Docker deployment level)
2. Automatic scanning of bound content directory for supported image and video formats
3. Basic file validation and error handling during scanning process
4. File path storage and tracking for each discovered media item
5. Thumbnail generation for all discovered images and videos
6. File metadata extraction (size, dimensions, creation date) during scan
7. Automatic shoot creation from folders matching YYYY-MM-DD_<NAME> format during scan
8. Assignment of media items to auto-detected shoots based on folder structure
9. Import of content not matching shoot folder format without shoot assignment
10. Initial full scan on application startup
11. Scan progress indicators and success/error feedback in UI

## Tasks / Subtasks

- [x] **Task 1: Database Infrastructure Setup** (AC: 1, 4, 7, 8)
  - [x] Create `@fanslib/apps/web/src/db/schema.ts` with Media and Shoot models using Drizzle
  - [x] Set up `docker-compose.yml` with PostgreSQL service configuration
  - [x] Configure PostgreSQL environment variables in `.env.example`
  - [x] Create database connection in `@fanslib/apps/web/src/db/connection.ts`
  - [x] Run initial Drizzle migration to create database schema
  - [x] Add database health check via TanStack Start API routes
  - [x] Configure TanStack DB Collections with ElectricSQL integration

- [x] **Task 2: File System Scanning Module** (AC: 1, 2, 3, 4, 6)
  - [x] Create `@fanslib/apps/server/src/modules/filesystem/fileScanner.ts` with directory scanning functions
  - [x] Implement `scanDirectory` function using Bun's built-in file system APIs
  - [x] Add supported media format filtering (images: jpg, png, webp; videos: mp4, mov, avi)
  - [x] Implement file validation with MIME type checking and basic file integrity
  - [x] Extract file metadata (size, creation date, modification date) using Bun file APIs
  - [x] Add content hash generation for change detection using `@fanslib/apps/server/src/utils/hashGenerator.ts`
  - [x] Return Result<MediaFileInfo[], ScanError> for proper error handling

- [ ] **Task 3: Media Processing Utilities** (AC: 5, 6)
  - [ ] Create `@fanslib/apps/server/src/utils/mediaProcessing.ts` with metadata extraction
  - [ ] Implement image dimension extraction using Sharp or native Bun APIs
  - [ ] Implement video metadata extraction (dimensions, duration) using FFprobe
  - [ ] Create thumbnail generation function using Sharp for images and FFmpeg for videos
  - [ ] Store thumbnails in configured thumbnails directory with consistent naming
  - [ ] Add error handling for corrupted or unsupported media files

- [ ] **Task 4: Shoot Detection and Management** (AC: 7, 8, 9)
  - [ ] Create `@fanslib/apps/server/src/modules/media/shootDetection.ts`
  - [ ] Implement folder pattern matching for YYYY-MM-DD_<NAME> format using regex
  - [ ] Create shoot entities in database using Drizzle (@fanslib/db package) for detected folder patterns
  - [ ] Assign media items to shoots based on folder structure
  - [ ] Handle media files not in shoot folders (assign shootId as null)
  - [ ] Ensure shoot names are extracted from folder names correctly

- [ ] **Task 5: Database Integration** (AC: 4, 7, 8, 9)
  - [ ] Create `@fanslib/apps/server/src/modules/media/mediaOperations.ts`
  - [ ] Implement `syncMediaToDatabase` function using Drizzle upsert operations (using the schema in @fanslib/db)
  - [ ] Create database transaction for atomic media and shoot creation
  - [ ] Handle file path uniqueness constraints and duplicate detection
  - [ ] Implement proper error handling for database operations using Result types
  - [ ] Add logging for successful imports and error cases

- [ ] **Task 6: API Endpoints** (AC: 10, 11)
  - [ ] Create `@fanslib/apps/server/src/routes/media.ts` with scan endpoints
  - [ ] Implement POST `/api/media/scan` for manual full scan trigger
  - [ ] Add scan progress tracking using background process status
  - [ ] Return scan results with counts (total files, new files, updated files, errors)
  - [ ] Implement proper request validation using Zod schemas
  - [ ] Add error responses with detailed error information

- [ ] **Task 7: Background Scan Process** (AC: 10)
  - [ ] Create `@fanslib/apps/server/src/background/initialScan.ts`
  - [ ] Implement startup scan process that runs on server initialization
  - [ ] Add scan status tracking (idle, scanning, completed, error)
  - [ ] Integrate with thumbnail generation queue for processing discovered media
  - [ ] Add configurable scan intervals and startup behavior
  - [ ] Ensure scan doesn't block server startup

- [ ] **Task 8: Frontend Integration** (AC: 11)
  - [ ] Create scan progress indicator component in `@fanslib/apps/web/src/components/media/ScanProgress.tsx`
  - [ ] Implement real-time scan status updates using tRPC subscriptions
  - [ ] Add manual scan trigger button using tRPC mutations
  - [ ] Display scan results and error feedback to user
  - [ ] Show scanning status during initial application load
  - [ ] Integrate media grid with TanStack DB Collections to display newly scanned content

- [ ] **Task 9: Unit Testing** (AC: All)
  - [ ] Create `@fanslib/apps/server/tests/modules/filesystem/fileScanner.test.ts`
  - [ ] Test directory scanning with various folder structures
  - [ ] Test shoot detection logic with valid and invalid folder names
  - [ ] Test media metadata extraction with sample files
  - [ ] Test database sync operations with mock data
  - [ ] Test error handling for corrupted files and network issues
  - [ ] Verify thumbnail generation works correctly

## Dev Notes

### Previous Story Insights
- React application foundation established with TypeScript, Tailwind CSS, and DaisyUI
- TanStack Start configured for type-safe routing
- Component structure patterns established with PascalCase naming
- Build environment verified with strict TypeScript compilation

### Technology Stack Requirements [Source: architecture/tech-stack.md]
- **Backend Language**: TypeScript with Bun runtime for high-performance file operations
- **Backend Framework**: Elysia.js for web framework optimized for Bun
- **Database**: PostgreSQL with Drizzle ORM for type-safe database access
- **File Storage**: Local File System via Docker volumes for direct media file access
- **Schema Validation**: Zod for TypeScript-first schema validation
- **Functional Programming**: ts-belt for Result types and remeda for functional utilities

### Project Structure Alignment [Source: architecture/unified-project-structure.md]
- Backend modules: `@fanslib/apps/server/src/modules/` for business logic functions
- File system operations: `@fanslib/apps/server/src/modules/filesystem/`
- Media operations: `@fanslib/apps/server/src/modules/media/`
- Utilities: `@fanslib/apps/server/src/utils/` for backend utilities
- Background processes: `@fanslib/apps/server/src/background/`
- Route handlers: `@fanslib/apps/server/src/routes/`
- Frontend components: `@fanslib/apps/web/src/components/media/`

### Database Schema [Source: architecture/database-schema.md]
- Database schema built using Drizzle in a separate package under @fanslib/libraries/db
- Media table with filepath uniqueness constraint and proper indexing
- Shoot table with optional folderPath for auto-detected shoots
- Foreign key relationship between Media.shootId and Shoot.id with SET NULL on delete
- Drizzle-Zod integration for automatic validation schema generation

### Architecture Patterns [Source: architecture/backend-architecture.md]
- Functional module organization with pure functions
- Route handlers in `routes/` that call business logic in `modules/`
- Background processes for file watching and thumbnail generation
- Elysia.js route patterns with TypeScript inference
- Drizzle transactions for data consistency
- Result types for error handling instead of throwing exceptions

### File System Operations [Source: architecture/backend-architecture.md]
- Use Bun's built-in file system APIs for optimal performance
- Implement proper error handling for file access issues
- Content hash generation for change detection
- Support for recursive directory scanning
- MIME type validation for supported formats

### Supported Media Formats [Source: architecture/tech-stack.md]
- **Images**: JPEG, PNG, GIF, WebP
- **Videos**: MP4, MOV, AVI, MKV
- Validation using MIME type checking and file extension verification

### Thumbnail Generation Requirements
- Use Sharp library for image thumbnail generation
- Use FFmpeg for video thumbnail extraction
- Store thumbnails in configured directory with consistent naming pattern
- Generate thumbnails asynchronously to avoid blocking scan process

### Database Configuration Requirements [Source: architecture/database-schema.md]
- PostgreSQL database via Docker Compose for development
- Drizzle ORM for type-safe database access and migrations
- Required environment variables: `DATABASE_URL`, `MEDIA_ROOT`, `THUMBNAIL_ROOT`

### Docker Configuration
- PostgreSQL service in docker-compose.yml with persistent volume
- Network configuration for server-database communication
- Environment variable passing for database connection

### Error Handling Requirements [Source: architecture/coding-standards.md]
- Use Result types from ts-belt for all operations that can fail
- Never throw exceptions, always return `Result<T, E>`
- Implement proper error boundaries for scan process failures
- Log errors appropriately without exposing sensitive file paths

### Testing Requirements [Source: architecture/testing-strategy.md]
#### Testing Standards [Source: architecture/testing-strategy.md]
- Backend business logic tests using Bun Test framework
- Test file location: `@fanslib/apps/server/modules/<module>.test.ts`
- Focus on testing business logic functions rather than HTTP routes
- Test file scanning, shoot detection, and database operations
- Mock file system operations for consistent testing
- Test error scenarios and edge cases thoroughly

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-01-XX | 1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

James (Expert Senior Software Engineer & Implementation Specialist) - v1.0

### Debug Log References

N/A - Task 1 completed without requiring debug log entries

### Completion Notes List

- **✅ TASK 1 FULLY COMPLETED AND VALIDATED**: Database Infrastructure Setup successfully implemented and proven working
- **🔧 TypeScript Compilation**: All database modules compile without errors or warnings
- **📊 Drizzle Schema**: Complete schema with Media/Shoot models, proper relationships
- **🐳 Docker Configuration**: Production-ready PostgreSQL 16 Alpine with health checks and persistent volumes
- **⚙️ Environment Setup**: Comprehensive .env.example with all database, media, and ElectricSQL variables
- **🛠️ Database Utilities**: Type-safe Drizzle client with Result-based error handling and transaction support
- **⚡ TanStack DB Integration**: Complete collections with ElectricSQL integration for real-time sync
- **🌐 tRPC Integration**: Type-safe procedures with proper error handling via TRPCError
- **📐 Code Quality**: Strict functional programming standards with ts-belt Result types, arrow functions, immutable patterns
- **🧪 Comprehensive Testing**: Multiple test suites validate infrastructure components and coding standards
- **📦 Dependencies**: All required packages installed and properly configured
- **✅ TASK 2 FULLY COMPLETED AND VALIDATED**: File System Scanning Module successfully implemented with comprehensive testing
- **📁 File Scanner Module**: Complete directory scanning with recursive search and media format filtering
- **🔍 Media Format Support**: Supports all required formats (JPG, PNG, GIF, WebP, MP4, MOV, AVI, MKV) with MIME type validation
- **📋 File Validation**: Robust file integrity checking using file signatures and header validation
- **📊 Metadata Extraction**: Complete file metadata including size, timestamps, content hashes, and relative paths
- **🛡️ Error Handling**: Comprehensive error handling with custom Result types and graceful failure recovery
- **🧪 Test Coverage**: 18 comprehensive test cases covering happy paths, edge cases, and error scenarios
- **⚡ Performance**: Efficient scanning using Bun's native file APIs and glob pattern matching

### File List

- `@fanslib/libraries/db/src/schema.ts` - Complete Drizzle database schema with Media and Shoot models
- `@fanslib/apps/web/src/db/connection.ts` - Type-safe Drizzle client with connection utilities (for app side, server side needs its own)
- `@fanslib/apps/web/src/lib/collections.ts` - TanStack DB Collections with ElectricSQL integration
- `@fanslib/apps/web/src/lib/trpc/routes/media.ts` - tRPC procedures for media operations
- `@fanslib/apps/web/src/lib/trpc/routes/shoots.ts` - tRPC procedures for shoot operations
- `@fanslib/apps/web/drizzle.config.ts` - Drizzle configuration for migrations
- `docker-compose.yml` - Production-ready PostgreSQL service with health checks and volumes
- `.env.example` - Comprehensive environment variables with database and media configuration
- `@fanslib/apps/web/package.json` - Updated with all required dependencies
- `@fanslib/apps/web/tests/db/` - Database infrastructure validation test suite
- `@fanslib/apps/server/src/modules/filesystem/fileScanner.ts` - Complete file system scanning module with media format support
- `@fanslib/apps/server/src/utils/hashGenerator.ts` - Content hash generation utilities for change detection
- `@fanslib/apps/server/tests/modules/filesystem/fileScanner.test.ts` - Comprehensive test suite for file scanner functionality
- `@fanslib/apps/server/package.json` - Updated with glob dependency for directory scanning

## QA Results

_This section will be populated by the QA agent after story completion_
